
# Typescript OpenWeather API

A Typescript web project providing a simple weather API, along with caching, logs, metrics and CI/CD.

Live url: https://openweather-typescript-priv.onrender.com


## Table of contents




## Usage

### Available routes


| Route              | Description                                                  |
|--------------------|--------------------------------------------------------------|
| `/get-token`       | Generates authentication token from user credentials         |
| `/weather/${city}` | Queries weather for a specific city                          |
| `/status`          | Provides domain config values and current checkout commit    |
| `/metrics`         | Exposes various metrics for monitoring purposes              |


### Authentication

- `/weather/${city}` endpoint requires authentication: A JWT Bearer token needs to be provided in request header such as `Authorization: Bearer ${TOKEN}`
- A JWT Bearer token should therefore be generated beforehand using `/get-token` endpoint, using valid user credentials:
   - Header must include `Content-Type: application/json`
   - Request must include data payload `{"username":"test","password":"password"}`

Todo: Add a simple mermaid graph here


### Requesting weather / TLDR

- Shell one-liner:
```shell
URL="https://openweather-typescript-priv.onrender.com" TOKEN=$(curl -s -X POST ${URL}/get-token -H "Content-Type: application/json" -d '{"username":"test","password":"password"}' | jq -r '.token') && curl -X GET ${URL}/weather/paris -H "Authorization: Bearer ${TOKEN}"
```
> Replace `test` and `password` values by real ones

API should return something like:
```json
{
  "city": "Paris",
  "weather": "Clouds",
  "temperature": 13.34
}
```

### Caching

Todo: Add a brief explaination of caching implementation
Cache ttl is defined by config (defaults to 600sec, aka 10min)


### Logs

- Logs are generated by Node.js process, according to defined LOG_LEVEL (defaults to WARN):

```shell
API listening at port 3000
[2025-11-01T16:22:22.514Z] WARN: Authentication attempt with missing credentials
[2025-11-01T16:22:22.517Z] WARN: Failed authentication attempt {"username":"wrong"}
[2025-11-01T16:22:22.523Z] WARN: Request without authorization header {"path":"/london"}
[2025-11-01T16:22:22.525Z] WARN: Invalid token verification {"path":"/london","error":"jwt malformed"}
[2025-11-01T16:22:26.455Z] ERROR: Failed to fetch weather data {"city":"parissss","error":"Request failed with status code 404"}
```

### Metrics

- Metrics data is available in json format at `/metrics`:
```json
{
  "uptimeSeconds": 19,
  "requests": {
    "total": 12
  },
  "endpoints": {
    "GET /status": {
      "count": 1,
      "avgDurationMs": 14,
      "minDurationMs": 14,
      "maxDurationMs": 14
    },
    "GET /metrics": {
      "count": 1,
      "avgDurationMs": 1,
      "minDurationMs": 1,
      "maxDurationMs": 1
    },
    "POST /get-token": {
      "count": 4,
      "avgDurationMs": 2,
      "minDurationMs": 0,
      "maxDurationMs": 3
    },
    "GET /weather/:city": {
      "count": 6,
      "avgDurationMs": 75,
      "minDurationMs": 0,
      "maxDurationMs": 209
    }
  },
  "cache": {
    "hits": 1,
    "misses": 3,
    "hitRate": 25
  },
  "errors": {
    "total": 5,
    "byStatusCode": {
      "400": 1,
      "401": 2,
      "403": 1,
      "500": 1
    }
  }
}
```

Todo: Add a brief description of how monitoring works and what could be done to monitor traffic and performances



## Required Secrets

| Name              | Description              | Environment             |
|-------------------|--------------------------|--------------------------|
| JWT_SECRET        | Secret string used as salt in JWT authentication     | Render                  |
| OWM_API_KEY       | Secret API key to access OpenWeatherMap API           | Render                  |
| RENDER_DEPLOY_KEY | Secret deploy key to deploy on render.com | GitHub                  |
| RENDER_APP_URL    | Public app URL used for e2e testing           | GitHub                  |
| E2E_AUTH_USERNAME | Secret username for e2e testing  | GitHub + Render         |
| E2E_AUTH_PASSWORD | Secret password for e2e testing  | GitHub + Render         |
| GROQ_API_KEY      | Secret API key used for `npm run check:unused` testing  | GitHub                  |


## Architecture Decisions

- Tech stack
- Configuration
- Directories


## CI/CD

Todo: Describe how CI/CD pipeline works (all + each job) + Add a simple mermaid graph


## Todo before production usage

### Changes required before deploying to production

- Upgrade /get-token endpoint to validate against user DB (requires persistent database service both on cloud + locally, and a way to populate database with real users as test ones)
- Remove E2E_AUTH_USERNAME E2E_AUTH_PASSWORD env vars from prod environement (keep only for dev env)
- Update /metrics format to Prometheus standard
- Add authentication to /metrics and /status routes for security 
- Update /metrics to expose additional useful metrics (such as per city calls, percentil performance p50 p95 p99)
- Provide an additional environement for preprod/dev purposes, adapt CD pipeline to automate deployments to it
- Improve CI pipeline with additional meaningful tests (technical as well as domain oriented)


### Other possible improvements

- Improve git workflow (CI at PR/MR level, CD to prod only from master, CD to dev env from other branches)
- Upgrade caching system to use redis
- Implement Hot reload of local environement when values from .env file are updated
- Migrate scripts/check-unused-code.js into a typescript sdk native github action of it's own (using it's own reo and calling it in CI)
- Improve scripts/check-unused-code.js to use a privately self hosted llm instead of a public third-party one to garantee confidentiality of closed code


## Local environment

### .env example

```
# Required local config:
OWM_API_KEY=secret
JWT_SECRET=secret

# Optional overrides:
E2E_AUTH_USERNAME=test
E2E_AUTH_PASSWORD=password
GROQ_API_KEY=secret
#LOG_LEVEL=INFO              # or ERROR, WARN, DEBUG
#WEATHER_UNITS=metric        # imperial, standard
#CACHE_TTL_SECONDS=60
#PORT=3000
```

### Common commands

As usual, common commands can be found in the `script` section of `package.json`, here is the jist of it:

- Start local environment:
```shell
npm run dev
```


- Run tests individually:
```shell
npm run lint
npm run audit
npm run test
npm run test:coverage
npm run test:e2e
npm run check:unused
```
- `test:e2e` requires `E2E_AUTH_USERNAME` and `E2E_AUTH_PASSWORD` values to be present in `.env` file
- `check:unused` requires `GROQ_API_KEY` value to be present in `.env` file

- Run all tests:
```shell
npm run all
```

- Manually API call:
```shell
URL="http://localhost:3000" TOKEN=$(curl -s -X POST ${URL}/get-token -H "Content-Type: application/json" -d '{"username":"test","password":"password"}' | jq -r '.token') && curl -X GET ${URL}/weather/paris -H "Authorization: Bearer ${TOKEN}"
```


## Wakeup Cronjob

Todo: Maybe add a wakeup Cronjob CI job to continiously wake up Render app during a specific period of time
